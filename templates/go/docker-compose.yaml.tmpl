version: '3.8'

services:
  {{ .ServiceName }}:
    build: .
    ports:
      - "{{ .HTTPPort | default "8080" }}:{{ .HTTPPort | default "8080" }}"
    environment:
      - ENVIRONMENT=development
      - PORT={{ .HTTPPort | default "8080" }}
      - LOG_LEVEL={{ .LogLevel | default "info" }}
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/{{ .ServiceName }}?sslmode=disable
      {{- if .CacheEnabled }}
      - REDIS_URL=redis://redis:6379
      {{- end }}
    depends_on:
      - postgres
      {{- if .CacheEnabled }}
      - redis
      {{- end }}
    networks:
      - app-network
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB={{ .ServiceName }}
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped

{{- if .CacheEnabled }}
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    restart: unless-stopped
{{- end }}

{{- if .MonitoringEnabled }}
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - app-network

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - app-network
{{- end }}

volumes:
  postgres_data:
  redis_data:
  grafana_data:

networks:
  app-network:
    driver: bridge